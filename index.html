<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Connection</title>
    <!-- Use Tailwind CSS for a clean, modern look -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4;
        }
    </style>
</head>
<body>

<div class="max-w-xl w-full bg-white p-8 rounded-xl shadow-lg border border-gray-200">
    <h1 class="text-3xl font-bold mb-6 text-center text-gray-900">Firestore Connection Demo</h1>
    <p class="text-center text-sm text-gray-500 mb-6">Enter some text and save it to your Firestore database. The data will be displayed below.</p>

    <!-- Display loading state -->
    <div id="loading" class="text-center text-blue-500 font-medium mb-4" style="display: none;">
        Connecting to Firebase...
    </div>

    <!-- Display user ID -->
    <div id="user-info" class="mb-4 bg-gray-100 p-3 rounded-md text-sm break-all">
        <span class="font-semibold text-gray-600">User ID:</span> <span id="user-id" class="text-gray-900 font-mono">Loading...</span>
    </div>

    <!-- Data Input Form -->
    <div class="mb-6">
        <label for="message-input" class="block text-sm font-medium text-gray-700 mb-1">Your Message</label>
        <div class="mt-1 flex gap-2">
            <input type="text" id="message-input" placeholder="Type something..."
                   class="flex-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            <button id="save-button"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-md font-semibold text-sm hover:bg-indigo-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                Save
            </button>
        </div>
        <p id="error-message" class="text-red-500 text-xs mt-2" style="display: none;"></p>
    </div>

    <!-- Displayed Messages Section -->
    <div>
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Saved Messages</h2>
        <div id="messages-container" class="space-y-4">
            <!-- Messages will be dynamically inserted here -->
            <p id="no-messages" class="text-gray-500 text-center text-sm">No messages yet. Save one to see it appear here!</p>
        </div>
    </div>
</div>

<script type="module">
    // Firebase SDK imports for a simple, single-file HTML app
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; // New import for Analytics

    // IMPORTANT: Replaced with your Firebase project's configuration
    // You can find this in your Firebase Project Settings -> General -> "Your apps" section
    const firebaseConfig = {
      apiKey: "AIzaSyC3C4HPktPmnu6E_N4PzKvW-eTLjYds8Gk",
      authDomain: "inventory-9feab.firebaseapp.com",
      projectId: "inventory-9feab",
      storageBucket: "inventory-9feab.firebasestorage.app",
      messagingSenderId: "10828991477",
      appId: "1:10828991477:web:cc50c1bb30a152579b2ebc",
      measurementId: "G-QZBEE87TVH" // Added measurementId
    };

    // Global variables provided by the environment
    const __app_id = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
    const __firebase_config = typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : JSON.stringify(firebaseConfig);
    const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;
    
    // Parse the Firebase config
    const parsedFirebaseConfig = JSON.parse(__firebase_config);

    // Initialize Firebase and get service instances
    const app = initializeApp(parsedFirebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const analytics = getAnalytics(app); // Initialized Analytics

    // Get references to DOM elements
    const saveButton = document.getElementById('save-button');
    const messageInput = document.getElementById('message-input');
    const messagesContainer = document.getElementById('messages-container');
    const userIdDisplay = document.getElementById('user-id');
    const errorMessage = document.getElementById('error-message');
    const loadingMessage = document.getElementById('loading');
    const noMessages = document.getElementById('no-messages');

    let userId = null;
    let authReady = false;

    // --- Authentication and Initialization ---

    // Listen for authentication state changes
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
            userIdDisplay.textContent = userId;
            authReady = true;
            loadingMessage.style.display = 'none';

            // Start listening for data changes after successful authentication
            listenForMessages();
        } else {
            // Sign in anonymously if no user is found
            try {
                if (__initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                errorMessage.textContent = "Failed to sign in. Check console for details.";
                errorMessage.style.display = 'block';
            }
        }
    });

    // --- Firestore Operations ---

    // Function to save a message to Firestore
    const saveMessage = async (message) => {
        if (!authReady || !userId) {
            errorMessage.textContent = "Authentication not ready. Please wait.";
            errorMessage.style.display = 'block';
            return;
        }

        const data = {
            message,
            timestamp: new Date()
        };

        const collectionPath = `/artifacts/${__app_id}/users/${userId}/messages`;

        try {
            await addDoc(collection(db, collectionPath), data);
            messageInput.value = ''; // Clear input field
            errorMessage.style.display = 'none';
        } catch (e) {
            console.error("Error adding document: ", e);
            errorMessage.textContent = "Error saving message. Please try again.";
            errorMessage.style.display = 'block';
        }
    };

    // Real-time listener for messages
    const listenForMessages = () => {
        const collectionPath = `/artifacts/${__app_id}/users/${userId}/messages`;
        const q = query(collection(db, collectionPath));
        
        onSnapshot(q, (querySnapshot) => {
            const messages = [];
            querySnapshot.forEach((doc) => {
                messages.push({ id: doc.id, ...doc.data() });
            });
            displayMessages(messages);
        }, (error) => {
            console.error("Error listening to collection: ", error);
            errorMessage.textContent = "Error fetching messages. Please check your security rules.";
            errorMessage.style.display = 'block';
        });
    };

    // --- UI Update Functions ---

    // Function to display messages in the UI
    const displayMessages = (messages) => {
        messagesContainer.innerHTML = ''; // Clear previous messages
        if (messages.length === 0) {
            noMessages.style.display = 'block';
        } else {
            noMessages.style.display = 'none';
            // Sort messages by timestamp descending
            messages.sort((a, b) => b.timestamp - a.timestamp);
            
            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = 'bg-gray-50 p-4 rounded-md shadow-sm border border-gray-200';
                messageElement.innerHTML = `
                    <p class="text-gray-700">${msg.message}</p>
                    <p class="text-xs text-gray-400 mt-1">${msg.timestamp.toDate().toLocaleString()}</p>
                `;
                messagesContainer.appendChild(messageElement);
            });
        }
    };

    // --- Event Listeners ---

    saveButton.addEventListener('click', () => {
        const message = messageInput.value.trim();
        if (message) {
            saveMessage(message);
        } else {
            errorMessage.textContent = "Message cannot be empty.";
            errorMessage.style.display = 'block';
        }
    });

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            saveButton.click();
        }
    });
</script>

</body>
</html>
